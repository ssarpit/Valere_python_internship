{% extends 'base.html' %}
{% block title %}{{ challenge.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-primary">{{ challenge.title }}</h2>
  <p>{{ challenge.description|safe }}</p>

  <h4>Sample Test Cases</h4>
  <ul>
    {% for test in sample_testcases %}
      <li>
        <strong>Input:</strong> {{ test.input }}<br>
        <strong>Output:</strong> {{ test.expected_output }}
      </li>
    {% endfor %}
  </ul>

  <hr>

  <h4 class="mt-4">Submit Your Code</h4>
  <div class="mb-3" id="editorBox"></div>
<button type="button" class="btn btn-success" onclick="submitCode()">Submit</button>


</div>

<!-- ✅ CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<div id="resultsBox" class="mt-4"></div> <!-- Add this inside content block before script -->

<script>
  const editor = CodeMirror(document.getElementById("editorBox"), {
value: `{{ previous_submission.code|default:"# Write your Python code here"|escapejs }}`,
    lineNumbers: true,
    mode: "python",
    theme: "default",
  });

  function submitCode() {
  const code = editor.getValue();
  const challengeId = "{{ challenge.id }}";

  if (!code.trim()) {
    alert("Please write some code before submitting.");
    return;
  }

  fetch(`/api/submit/${challengeId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ code: code })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || 'Unknown error');
      });
    }
    return response.json();
  })
  .then(data => {
    alert("✅ Submission stored successfully!\n\nAdmin will review and publish results later.");
    console.log("Submitted code:", code);
    window.location.href="/contests/1/"

  })
  .catch(error => {
    console.error("Error:", error);
    alert("❌ Submission failed. " + error.message);
  });
}

</script>


{% endblock %}

{% extends 'base.html' %}
{% block title %}{{ contest.name }} - Contest Details{% endblock %}

{% block content %}
<style>
  .timer-box {
    font-size: 1.5rem;
    color: #e63946;
    background: #f8f9fa;
    padding: 15px;
    margin-top: 10px;
    border-radius: 10px;
    width: fit-content;
  }
</style>

<div class="container mt-5">
  <h2 class="mb-3 text-primary">ğŸ {{ contest.name }}</h2>
  <p><strong>Start Date:</strong> {{ contest.start_time|date:"F j, Y" }}</p>
  <p><strong>End Date:</strong> {{ contest.end_time|date:"F j, Y" }}</p>
  <p>{{ contest.description }}</p>

  <!-- Countdown Timer -->
  <div class="timer-box" id="timer">â³ Time Remaining: <span id="timeLeft"></span></div>

  <h4 class="mt-4">ğŸ§  Challenges in This Contest</h4>
  <ul class="list-group">
    {% for challenge in challenges %}
      <li class="list-group-item d-flex justify-content-between align-items-center {% if challenge.id in solved_challenges %}list-group-item-success{% endif %}">
        {{ challenge.title }}
       {% if not already_submitted %}
  <a href="{% url 'challenges:challenge_detail' challenge.id %}" class="btn btn-outline-success">
    Solve
  </a>
{% else %}
  <span class="text-muted">âœ… Submitted</span>
{% endif %}

      </li>
    {% empty %}
      <li class="list-group-item">No challenges added.</li>
    {% endfor %}
  </ul>

  <div class="mt-4 text-center">
    {% if not already_submitted %}
      <button id="submitBtn" class="btn btn-success btn-lg" onclick="submitContest()">ğŸ¯ Submit Contest</button>
    {% endif %}
    <a href="{% url 'challenges:leaderboard' %}" class="btn btn-outline-primary mt-3">ğŸ View Leaderboard</a>
  </div>

  <!-- Live Leaderboard Placeholder -->
  <div id="liveLeaderboard" class="mt-5"></div>
</div>

<!-- âœ… Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">ğŸ‰ Contest Submitted</h5>
      </div>
      <div class="modal-body">
        Your contest was successfully submitted! Redirecting to leaderboard...
      </div>
    </div>
  </div>
</div>

<!-- â±ï¸ Timer + Submission Script -->
<!-- â±ï¸ Timer + Submission Script -->
<script>
  const startedAt = new Date("{{ started_at|date:'c' }}").getTime();
  const contestId = {{ contest.id }};
  const endTime = startedAt + (60 * 60 * 1000); // 60 minutes in ms

  const timerElement = document.getElementById("timeLeft");
  let timerInterval;

  function updateTimer() {
    const nowTime = new Date().getTime();
    const timeLeft = endTime - nowTime;

    if (timeLeft <= 0) {
      timerElement.innerHTML = "â±ï¸ Time's up!";
      clearInterval(timerInterval);
      disableSubmitButton();
      autoSubmitContest();  // Auto-submit
    } else {
      // Calculate remaining minutes and seconds from the timeLeft
      const remainingSeconds = Math.floor(timeLeft / 1000);
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      timerElement.innerHTML = `${minutes}m ${seconds}s`;
    }
  }

  function disableSubmitButton() {
    const btn = document.getElementById("submitBtn");
    if (btn) {
      btn.disabled = true;
      btn.classList.add("disabled");
    }
  }

  function autoSubmitContest(isManual = false) {
    // Calculate elapsed time in seconds from the contest start
    const nowTime = new Date().getTime();
    const timeTakenSeconds = Math.floor((nowTime - startedAt) / 1000);
    const minutes = Math.floor(timeTakenSeconds / 60);
    const seconds = timeTakenSeconds % 60;
    const timeTakenFormatted = `${minutes}m:${seconds}s`;

    fetch(`/contests/submit_contest/${contestId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ 
        time_taken_seconds: timeTakenSeconds,
        time_taken_display: timeTakenFormatted
      })
    })
    .then(async response => {
      const contentType = response.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const text = await response.text();
        throw new Error("Invalid server response:\n" + text);
      }

      const data = await response.json();
      if (!response.ok) throw new Error(data.error || data.message || "Unknown error");

      clearInterval(timerInterval);
      disableSubmitButton();

      // âœ… Show modal
      const modal = new bootstrap.Modal(document.getElementById('successModal'));
      modal.show();

      // â³ Redirect to leaderboard after 3 seconds
      setTimeout(() => {
        window.location.href = "{% url 'challenges:leaderboard' %}";
      }, 3000);
    })
    .catch(error => {
      console.error("Submission error:", error);
      alert("âŒ Submission failed: " + error.message);
    });
  }

  function submitContest() {
    autoSubmitContest(true);  // Manual trigger
  }

  // â³ Start timer
  timerInterval = setInterval(updateTimer, 1000);
  updateTimer();
</script>

{% endblock %}

{% extends 'base.html' %}
{% block title %}{{ contest.name }} - Contest Details{% endblock %}

{% block content %}
<style>
  .timer-box {
    font-size: 1.5rem;
    color: #e63946;
    background: #f8f9fa;
    padding: 15px;
    margin-top: 10px;
    border-radius: 10px;
    width: fit-content;
  }
</style>

<div class="container mt-5">
  <h2 class="mb-3 text-primary">ğŸ {{ contest.name }}</h2>
  <p><strong>Start Date:</strong> {{ contest.start_time|date:"F j, Y" }}</p>
  <p><strong>End Date:</strong> {{ contest.end_time|date:"F j, Y" }}</p>
  <p>{{ contest.description }}</p>

  <!-- Timer -->
  <div class="timer-box" id="timer">â³ Time Remaining: <span id="timeLeft"></span></div>

  <!-- âœ… Dynamic Challenge List -->
  <h4 class="mt-4">ğŸ§  Challenges in This Contest</h4>
  <ul class="list-group" id="challengeList">
    <li class="list-group-item">Loading challenges...</li>
  </ul>

  <!-- Submit Button + Leaderboard -->
  <div class="mt-4 text-center">
    {% if not already_submitted %}
      <button id="submitBtn" class="btn btn-success btn-lg" onclick="submitContest()">ğŸ¯ Submit Contest</button>
    {% endif %}
    <a href="{% url 'challenges:leaderboard' %}" class="btn btn-outline-primary mt-3">ğŸ View Leaderboard</a>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">ğŸ‰ Contest Submitted</h5>
        </div>
        <div class="modal-body">Your contest was successfully submitted! Redirecting to leaderboard...</div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… JavaScript -->
<script>
  const startedAt = new Date("{{ started_at|date:'c' }}").getTime();
  const contestId = {{ contest.id }};
  const endTime = startedAt + (60 * 60 * 1000); // 60 min

  const timerElement = document.getElementById("timeLeft");
  let timerInterval;

  function updateTimer() {
    const now = new Date().getTime();
    const left = endTime - now;

    if (left <= 0) {
      timerElement.innerHTML = "â±ï¸ Time's up!";
      clearInterval(timerInterval);
      disableSubmitButton();
      autoSubmitContest(); // â±ï¸ Auto-submit
    } else {
      const min = Math.floor(left / 60000);
      const sec = Math.floor((left % 60000) / 1000);
      timerElement.innerHTML = `${min}m ${sec}s`;
    }
  }

  function disableSubmitButton() {
    const btn = document.getElementById("submitBtn");
    if (btn) {
      btn.disabled = true;
      btn.classList.add("disabled");
    }
  }

  function autoSubmitContest() {
    const now = new Date().getTime();
    const seconds = Math.floor((now - startedAt) / 1000);
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    const formatted = `${min}m:${sec}s`;

    fetch(`/contests/submit_contest/${contestId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({
        time_taken_seconds: seconds,
        time_taken_display: formatted
      })
    })
    .then(res => res.json())
    .then(data => {
      clearInterval(timerInterval);
      disableSubmitButton();

      const modal = new bootstrap.Modal(document.getElementById('successModal'));
      modal.show();
      setTimeout(() => {
        window.location.href = "{% url 'challenges:leaderboard' %}";
      }, 3000);
    })
    .catch(err => {
      alert("âŒ Submission failed: " + err.message);
      console.error("Submission error:", err);
    });
  }

  function submitContest() {
    autoSubmitContest(true);
  }

  // ğŸ§  Fetch Challenges for the Contest
  fetch(`/api/contests/${contestId}/challenges/`)
  .then(response => {
    if (!response.ok) {
      throw new Error("Failed to load challenges.");
    }
    return response.json();
  })
  .then(data => {
    const list = document.getElementById("challengeList");
    list.innerHTML = ""; // âœ… clear loading text

    if (data.length === 0) {
      list.innerHTML = "<li class='list-group-item'>No challenges available.</li>";
      return;
    }

    data.forEach(challenge => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";

      li.innerHTML = `
        <span>${challenge.title}</span>
        {% if not already_submitted %}
          <a href="/challenges/${challenge.id}/" class="btn btn-outline-success">Solve</a>
        {% else %}
          <span class="text-muted">âœ… Submitted</span>
        {% endif %}
      `;

      list.appendChild(li);
    });
  })
  .catch(error => {
    console.error("Challenge fetch error:", error);
    const list = document.getElementById("challengeList");
    list.innerHTML = `<li class="list-group-item text-danger">âŒ Failed to load challenges</li>`;
  });

  timerInterval = setInterval(updateTimer, 1000);
  updateTimer();
</script>
{% endblock %}
